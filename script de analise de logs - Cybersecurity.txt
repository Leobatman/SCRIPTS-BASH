#!/bin/bash

# =============================================================================
# SCRIPT: ANALISER_FORENSE_LOG - Ferramenta Profissional de An√°lise Forense
# LOCALIZA√á√ÉO: /analiser_forense_log
# DESCRI√á√ÉO: An√°lise forense avan√ßada de logs de acesso para investiga√ß√£o de seguran√ßa
# VERS√ÉO: 1.0
# AUTOR: LEONARDO PEREIRA 
# =============================================================================

# Configura√ß√µes globais
readonly LOG_FILE="/access_log"
readonly TIMESTAMP=$(date +%Y%m%d_%H%M%S)
readonly OUTPUT_DIR="/forensic_analysis_$TIMESTAMP"
readonly REPORT_FILE="${OUTPUT_DIR}/security_analysis_report_$TIMESTAMP.txt"
readonly EVIDENCE_DIR="${OUTPUT_DIR}/evidence"
readonly STATS_DIR="${OUTPUT_DIR}/statistics"
readonly THREAT_INTEL_DIR="${OUTPUT_DIR}/threat_intelligence"

# Cores para output (Professional Color Scheme)
readonly RED='\033[0;91m'
readonly GREEN='\033[0;92m'
readonly YELLOW='\033[0;93m'
readonly BLUE='\033[0;94m'
readonly PURPLE='\033[0;95m'
readonly CYAN='\033[0;96m'
readonly BOLD='\033[1m'
readonly NC='\033[0m'
readonly DIVIDER="=============================================================="

# Listas de indicadores de comprometimento (IOCs)
readonly SQL_KEYWORDS=("union" "select" "insert" "delete" "drop" "exec" "xp_" "'or'" "'or 1=1" "1=1" "--")
readonly XSS_PATTERNS=("<script>" "alert(" "onerror=" "onload=" "eval(" "javascript:" "fromCharCode")
readonly LFI_INDICATORS=("etc/passwd" "proc/self" "/../" "..\\" "etc/shadow" "boot.ini" "win.ini")
readonly RCE_INDICATORS=("cmd.exe" "/bin/bash" "/bin/sh" "whoami" "id" "uname" "eval(" "system(" "exec(")
readonly SCANNER_AGENTS=("nmap" "sqlmap" "nikto" "metasploit" "burpsuite" "acunetix" "nessus" "w3af" "zap")
readonly MALICIOUS_PATHS=("admin" "wp-admin" "administrator" "login" "config" "env" ".env" "backup" "phpmyadmin")

# Vari√°veis de estado
declare -gA THREAT_LEVELS=([CRITICAL]=0 [HIGH]=0 [MEDIUM]=0 [LOW]=0)
declare -gA ATTACK_VECTORS=([SQLi]=0 [XSS]=0 [LFI]=0 [RCE]=0 [SCANNING]=0 [AUTH_BYPASS]=0)
declare -gA TOP_OFFENDERS
declare -gA SUSPICIOUS_IPS

# =============================================================================
# FUN√á√ïES DE LOGGING E OUTPUT 
# =============================================================================

log_message() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "${REPORT_FILE}"
}

log_section() {
    echo -e "\n${PURPLE}${BOLD}$1${NC}" | tee -a "${REPORT_FILE}"
    echo -e "${PURPLE}$DIVIDER${NC}" | tee -a "${REPORT_FILE}"
}

log_subsection() {
    echo -e "\n${CYAN}${BOLD}$1${NC}" | tee -a "${REPORT_FILE}"
}

log_critical() {
    echo -e "${RED}${BOLD}[CR√çTICO]${NC} $1" | tee -a "${REPORT_FILE}"
    ((THREAT_LEVELS[CRITICAL]++))
}

log_high() {
    echo -e "${RED}[ALTO]${NC} $1" | tee -a "${REPORT_FILE}"
    ((THREAT_LEVELS[HIGH]++))
}

log_medium() {
    echo -e "${YELLOW}[M√âDIO]${NC} $1" | tee -a "${REPORT_FILE}"
    ((THREAT_LEVELS[MEDIUM]++))
}

log_low() {
    echo -e "${GREEN}[BAIXO]${NC} $1" | tee -a "${REPORT_FILE}"
    ((THREAT_LEVELS[LOW]++))
}

log_success() {
    echo -e "${GREEN}${BOLD}[SUCESSO]${NC} $1" | tee -a "${REPORT_FILE}"
}

# =============================================================================
# FUN√á√ïES DE VALIDA√á√ÉO E CONFIGURA√á√ÉO
# =============================================================================

validate_environment() {
    log_section "VALIDA√á√ÉO DO AMBIENTE"
    
    # Verificar se √© root
    if [[ $EUID -eq 0 ]]; then
        log_success "Executando com privil√©gios de root"
    else
        log_medium "Executando sem privil√©gios de root - algumas an√°lises podem ser limitadas"
    fi

    # Verificar se o arquivo de log existe
    if [[ ! -f "$LOG_FILE" ]]; then
        log_critical "Arquivo $LOG_FILE n√£o encontrado!"
        exit 1
    fi
    
    # Verificar permiss√µes de leitura
    if [[ ! -r "$LOG_FILE" ]]; then
        log_critical "Sem permiss√£o para ler o arquivo $LOG_FILE"
        exit 1
    fi
    
    log_success "Arquivo de log validado: $LOG_FILE"
}

setup_analysis_environment() {
    log_section "CONFIGURA√á√ÉO DO AMBIENTE DE AN√ÅLISE"
    
    # Criar diret√≥rios de trabalho
    local dirs=("$OUTPUT_DIR" "$EVIDENCE_DIR" "$STATS_DIR" "$THREAT_INTEL_DIR")
    
    for dir in "${dirs[@]}"; do
        if mkdir -p "$dir"; then
            log_success "Diret√≥rio criado: $dir"
        else
            log_critical "Falha ao criar diret√≥rio: $dir"
            exit 1
        fi
    done
    
    # Iniciar relat√≥rio
    echo "RELAT√ìRIO DE AN√ÅLISE FORENSE - $(date '+%Y-%m-%d %H:%M:%S')" > "${REPORT_FILE}"
    echo "Arquivo analisado: $LOG_FILE" >> "${REPORT_FILE}"
    echo "Analisador: $0" >> "${REPORT_FILE}"
    echo "$DIVIDER" >> "${REPORT_FILE}"
}

# =============================================================================
# FUN√á√ïES DE AN√ÅLISE FORENSE
# =============================================================================

collect_basic_forensics() {
    log_section "COLETA DE INFORMA√á√ïES FORENSES B√ÅSICAS"
    
    local file_hash=$(sha256sum "$LOG_FILE" | cut -d' ' -f1)
    local file_size=$(du -h "$LOG_FILE" | cut -f1)
    local modified_time=$(stat -c %y "$LOG_FILE")
    local inode_info=$(stat -c "Inode: %i | UID: %u | GID: %g" "$LOG_FILE")
    
    log_message "Hash SHA256: $file_hash"
    log_message "Tamanho do arquivo: $file_size"
    log_message "Data de modifica√ß√£o: $modified_time"
    log_message "Informa√ß√µes de inode: $inode_info"
    log_message "Total de entradas: $(wc -l < "$LOG_FILE")"
    
    # Salvar informa√ß√µes forenses
    echo "EVID√äNCIAS FORENSES B√ÅSICAS" > "${EVIDENCE_DIR}/basic_forensics.txt"
    echo "Hash SHA256: $file_hash" >> "${EVIDENCE_DIR}/basic_forensics.txt"
    echo "Tamanho: $file_size" >> "${EVIDENCE_DIR}/basic_forensics.txt"
    echo "Modifica√ß√£o: $modified_time" >> "${EVIDENCE_DIR}/basic_forensics.txt"
    echo "$inode_info" >> "${EVIDENCE_DIR}/basic_forensics.txt"
}

analyze_temporal_patterns() {
    log_section "AN√ÅLISE DE PADR√ïES TEMPORAIS"
    
    log_subsection "Distribui√ß√£o por hor√°rio"
    awk -F'[:[]' '{print $2}' "$LOG_FILE" | sort | uniq -c | head -24 > "${STATS_DIR}/hourly_distribution.txt"
    cat "${STATS_DIR}/hourly_distribution.txt" | tee -a "${REPORT_FILE}"
    
    log_subsection "Distribui√ß√£o por dia"
    awk -F'[/:]' '{print $1}' "$LOG_FILE" | sort | uniq -c > "${STATS_DIR}/daily_distribution.txt"
    tail -10 "${STATS_DIR}/daily_distribution.txt" | tee -a "${REPORT_FILE}"
    
    # Detectar picos de atividade
    local peak_hour=$(awk '$1 > 1000 {print $2}' "${STATS_DIR}/hourly_distribution.txt" | head -1)
    if [[ -n "$peak_hour" ]]; then
        log_medium "Pico de atividade detectado √†s $peak_hour horas"
    fi
}

analyze_ip_addresses() {
    log_section "AN√ÅLISE DE ENDERE√áOS IP"
    
    log_subsection "Top 20 IPs por volume de requisi√ß√µes"
    awk '{print $1}' "$LOG_FILE" | sort | uniq -c | sort -nr | head -20 > "${STATS_DIR}/top_ips.txt"
    cat "${STATS_DIR}/top_ips.txt" | tee -a "${REPORT_FILE}"
    
    log_subsection "IPs √∫nicos totais"
    local unique_ips=$(awk '{print $1}' "$LOG_FILE" | sort -u | wc -l)
    log_message "Total de IPs distintos: $unique_ips"
    
    # Identificar IPs com padr√µes suspeitos
    log_subsection "Padr√µes de IP suspeitos"
    awk '{print $1}' "$LOG_FILE" | sort | uniq -c | awk '$1 > 1000 {print $2 " - " $1 " requests"}' > "${EVIDENCE_DIR}/suspicious_ips.txt"
    
    if [[ -s "${EVIDENCE_DIR}/suspicious_ips.txt" ]]; then
        log_high "IPs com volume anormal de requisi√ß√µes:"
        cat "${EVIDENCE_DIR}/suspicious_ips.txt" | tee -a "${REPORT_FILE}"
        
        # Adicionar √† lista de ofensores
        while read -r line; do
            local ip=$(echo "$line" | awk '{print $1}')
            local count=$(echo "$line" | awk '{print $3}')
            TOP_OFFENDERS["$ip"]=$count
        done < "${EVIDENCE_DIR}/suspicious_ips.txt"
    else
        log_success "Nenhum IP com volume excessivo detectado"
    fi
}

analyze_http_methods() {
    log_section "AN√ÅLISE DE M√âTODOS HTTP"
    
    log_subsection "Distribui√ß√£o de m√©todos HTTP"
    awk '{print $6}' "$LOG_FILE" | sed 's/"//g' | sort | uniq -c | sort -nr > "${STATS_DIR}/http_methods.txt"
    cat "${STATS_DIR}/http_methods.txt" | tee -a "${REPORT_FILE}"
    
    # Verificar m√©todos potencialmente perigosos
    local dangerous_methods=$(grep -E "(PUT|DELETE|TRACE|CONNECT)" "${STATS_DIR}/http_methods.txt" | awk '{sum += $1} END {print sum}')
    if [[ $dangerous_methods -gt 0 ]]; then
        log_high "M√©todos HTTP potencialmente perigosos detectados: $dangerous_methods requisi√ß√µes"
        grep -E "(PUT|DELETE|TRACE|CONNECT)" "${STATS_DIR}/http_methods.txt" | tee -a "${REPORT_FILE}"
    fi
}

analyze_status_codes() {
    log_section "AN√ÅLISE DE C√ìDIGOS DE STATUS HTTP"
    
    log_subsection "Distribui√ß√£o de c√≥digos de status"
    awk '{print $9}' "$LOG_FILE" | sort | uniq -c | sort -nr > "${STATS_DIR}/status_codes.txt"
    cat "${STATS_DIR}/status_codes.txt" | tee -a "${REPORT_FILE}"
    
    # Analisar c√≥digos de erro
    local client_errors=$(awk '/ 4[0-9]{2} / {count++} END {print count}' "$LOG_FILE")
    local server_errors=$(awk '/ 5[0-9]{2} / {count++} END {print count}' "$LOG_FILE")
    
    log_message "Erros cliente (4xx): $client_errors"
    log_message "Erros servidor (5xx): $server_errors"
    
    if [[ $server_errors -gt 100 ]]; then
        log_high "N√∫mero elevado de erros de servidor (5xx) detectado"
    fi
}

analyze_user_agents() {
    log_section "AN√ÅLISE DE USER AGENTS"
    
    log_subsection "User Agents mais frequentes"
    awk -F'"' '{print $6}' "$LOG_FILE" | sort | uniq -c | sort -nr | head -15 > "${STATS_DIR}/user_agents.txt"
    cat "${STATS_DIR}/user_agents.txt" | tee -a "${REPORT_FILE}"
    
    # Detectar user agents de scanners e ferramentas automatizadas
    log_subsection "User Agents suspeitos"
    for agent in "${SCANNER_AGENTS[@]}"; do
        local count=$(grep -ci "$agent" "$LOG_FILE")
        if [[ $count -gt 0 ]]; then
            log_high "Scanner detectado: $agent ($count ocorr√™ncias)"
            grep -i "$agent" "$LOG_FILE" | awk '{print $1}' | sort -u >> "${EVIDENCE_DIR}/scanner_ips.txt"
            ((ATTACK_VECTORS[SCANNING]+=count))
        fi
    done
    
    # Identificar user agents vazios ou incomuns
    local empty_agents=$(grep -ci '"-"' "$LOG_FILE")
    if [[ $empty_agents -gt 0 ]]; then
        log_medium "User Agents vazios detectados: $empty_agents"
    fi
}

detect_sql_injection() {
    log_subsection "Detec√ß√£o de Tentativas de SQL Injection"
    
    local total_sqli=0
    for pattern in "${SQL_KEYWORDS[@]}"; do
        local count=$(grep -ci "$pattern" "$LOG_FILE")
        if [[ $count -gt 0 ]]; then
            log_high "Padr√£o SQLi detectado: $pattern ($count ocorr√™ncias)"
            grep -i "$pattern" "$LOG_FILE" | awk '{print $1}' | sort -u >> "${EVIDENCE_DIR}/sqli_ips.txt"
            ((total_sqli+=count))
        fi
    done
    
    if [[ $total_sqli -gt 0 ]]; then
        ATTACK_VECTORS[SQLi]=$total_sqli
        log_critical "Total de indicadores de SQL Injection: $total_sqli"
        # Coletar IPs √∫nicos envolvidos em SQLi
        sort -u "${EVIDENCE_DIR}/sqli_ips.txt" > "${EVIDENCE_DIR}/unique_sqli_ips.txt"
        local unique_ips=$(wc -l < "${EVIDENCE_DIR}/unique_sqli_ips.txt")
        log_high "IPs √∫nicos envolvidos em SQLi: $unique_ips"
    else
        log_success "Nenhum indicador de SQL Injection detectado"
    fi
}

detect_xss_attempts() {
    log_subsection "Detec√ß√£o de Tentativas de XSS"
    
    local total_xss=0
    for pattern in "${XSS_PATTERNS[@]}"; do
        local count=$(grep -ci "$pattern" "$LOG_FILE")
        if [[ $count -gt 0 ]]; then
            log_high "Padr√£o XSS detectado: $pattern ($count ocorr√™ncias)"
            grep -i "$pattern" "$LOG_FILE" | awk '{print $1}' | sort -u >> "${EVIDENCE_DIR}/xss_ips.txt"
            ((total_xss+=count))
        fi
    done
    
    if [[ $total_xss -gt 0 ]]; then
        ATTACK_VECTORS[XSS]=$total_xss
        log_critical "Total de indicadores de XSS: $total_xss"
    else
        log_success "Nenhum indicador de XSS detectado"
    fi
}

detect_lfi_attempts() {
    log_subsection "Detec√ß√£o de Tentativas de Local File Inclusion"
    
    local total_lfi=0
    for pattern in "${LFI_INDICATORS[@]}"; do
        local count=$(grep -ci "$pattern" "$LOG_FILE")
        if [[ $count -gt 0 ]]; then
            log_high "Padr√£o LFI detectado: $pattern ($count ocorr√™ncias)"
            grep -i "$pattern" "$LOG_FILE" | awk '{print $1}' | sort -u >> "${EVIDENCE_DIR}/lfi_ips.txt"
            ((total_lfi+=count))
        fi
    done
    
    if [[ $total_lfi -gt 0 ]]; then
        ATTACK_VECTORS[LFI]=$total_lfi
        log_critical "Total de indicadores de LFI: $total_lfi"
    else
        log_success "Nenhum indicador de LFI detectado"
    fi
}

detect_rce_attempts() {
    log_subsection "Detec√ß√£o de Tentativas de Remote Code Execution"
    
    local total_rce=0
    for pattern in "${RCE_INDICATORS[@]}"; do
        local count=$(grep -ci "$pattern" "$LOG_FILE")
        if [[ $count -gt 0 ]]; then
            log_high "Padr√£o RCE detectado: $pattern ($count ocorr√™ncias)"
            grep -i "$pattern" "$LOG_FILE" | awk '{print $1}' | sort -u >> "${EVIDENCE_DIR}/rce_ips.txt"
            ((total_rce+=count))
        fi
    done
    
    if [[ $total_rce -gt 0 ]]; then
        ATTACK_VECTORS[RCE]=$total_rce
        log_critical "Total de indicadores de RCE: $total_rce"
    else
        log_success "Nenhum indicador de RCE detectado"
    fi
}

detect_path_traversal() {
    log_subsection "Detec√ß√£o de Tentativas de Path Traversal"
    
    local total_traversal=$(grep -c "\.\./" "$LOG_FILE")
    if [[ $total_traversal -gt 0 ]]; then
        ATTACK_VECTORS[LFI]=$((ATTACK_VECTORS[LFI] + total_traversal))
        log_high "Tentativas de Path Traversal detectadas: $total_traversal"
        grep "\.\./" "$LOG_FILE" | awk '{print $1}' | sort -u > "${EVIDENCE_DIR}/traversal_ips.txt"
    else
        log_success "Nenhuma tentativa de Path Traversal detectada"
    fi
}

analyze_sensitive_paths() {
    log_subsection "An√°lise de Acesso a Paths Sens√≠veis"
    
    local total_sensitive=0
    for path in "${MALICIOUS_PATHS[@]}"; do
        local count=$(grep -ci "$path" "$LOG_FILE")
        if [[ $count -gt 0 ]]; then
            log_medium "Acesso a path sens√≠vel: $path ($count ocorr√™ncias)"
            grep -i "$path" "$LOG_FILE" | awk '{print $1,$7,$9}' | sort -u >> "${EVIDENCE_DIR}/sensitive_access.txt"
            ((total_sensitive+=count))
        fi
    done
    
    if [[ $total_sensitive -gt 0 ]]; then
        log_high "Total de acessos a paths sens√≠veis: $total_sensitive"
    else
        log_success "Nenhum acesso a paths sens√≠veis detectado"
    fi
}

generate_threat_intelligence() {
    log_section "INTELIG√äNCIA DE AMEA√áAS"
    
    # Consolidar IPs maliciosos
    cat "${EVIDENCE_DIR}"/*_ips.txt 2>/dev/null | sort -u > "${THREAT_INTEL_DIR}/malicious_ips.txt"
    local malicious_ip_count=$(wc -l < "${THREAT_INTEL_DIR}/malicious_ips.txt" 2>/dev/null || echo 0)
    
    if [[ $malicious_ip_count -gt 0 ]]; then
        log_high "IPs maliciosos identificados: $malicious_ip_count"
        # Gerar lista para bloqueio
        awk '{print $1 "# Malicious activity detected"}' "${THREAT_INTEL_DIR}/malicious_ips.txt" > \
            "${THREAT_INTEL_DIR}/ip_blocklist.txt"
    else
        log_success "Nenhum IP malicioso identificado"
    fi
    
    # Gerar IOCs
    echo "Indicators of Compromise (IOCs)" > "${THREAT_INTEL_DIR}/iocs.txt"
    echo "Generated: $(date)" >> "${THREAT_INTEL_DIR}/iocs.txt"
    echo "==========================================" >> "${THREAT_INTEL_DIR}/iocs.txt"
    echo "Malicious IPs: $malicious_ip_count" >> "${THREAT_INTEL_DIR}/iocs.txt"
    echo "Attack Vectors:" >> "${THREAT_INTEL_DIR}/iocs.txt"
    for vector in "${!ATTACK_VECTORS[@]}"; do
        if [[ ${ATTACK_VECTORS[$vector]} -gt 0 ]]; then
            echo "  $vector: ${ATTACK_VECTORS[$vector]}" >> "${THREAT_INTEL_DIR}/iocs.txt"
        fi
    done
}

generate_executive_summary() {
    log_section "RELAT√ìRIO EXECUTIVO"
    
    local total_lines=$(wc -l < "$LOG_FILE")
    local unique_ips=$(awk '{print $1}' "$LOG_FILE" | sort -u | wc -l)
    local analysis_time=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "RELAT√ìRIO EXECUTIVO DE SEGURAN√áA" | tee -a "${REPORT_FILE}"
    echo "==========================================" | tee -a "${REPORT_FILE}"
    echo "Data da an√°lise: $analysis_time" | tee -a "${REPORT_FILE}"
    echo "Total de entradas analisadas: $total_lines" | tee -a "${REPORT_FILE}"
    echo "IPs √∫nicos identificados: $unique_ips" | tee -a "${REPORT_FILE}"
    echo "" | tee -a "${REPORT_FILE}"
    
    echo "N√çVEL DE AMEA√áA" | tee -a "${REPORT_FILE}"
    echo "------------------------------------------" | tee -a "${REPORT_FILE}"
    echo "Cr√≠tico: ${THREAT_LEVELS[CRITICAL]}" | tee -a "${REPORT_FILE}"
    echo "Alto: ${THREAT_LEVELS[HIGH]}" | tee -a "${REPORT_FILE}"
    echo "M√©dio: ${THREAT_LEVELS[MEDIUM]}" | tee -a "${REPORT_FILE}"
    echo "Baixo: ${THREAT_LEVELS[LOW]}" | tee -a "${REPORT_FILE}"
    echo "" | tee -a "${REPORT_FILE}"
    
    echo "VETORES DE ATAQUE DETECTADOS" | tee -a "${REPORT_FILE}"
    echo "------------------------------------------" | tee -a "${REPORT_FILE}"
    for vector in "${!ATTACK_VECTORS[@]}"; do
        if [[ ${ATTACK_VECTORS[$vector]} -gt 0 ]]; then
            echo "$vector: ${ATTACK_VECTORS[$vector]}" | tee -a "${REPORT_FILE}"
        fi
    done
    
    echo "" | tee -a "${REPORT_FILE}"
    echo "RECOMENDA√á√ïES" | tee -a "${REPORT_FILE}"
    echo "------------------------------------------" | tee -a "${REPORT_FILE}"
    
    if [[ ${THREAT_LEVELS[CRITICAL]} -gt 0 ]]; then
        echo "üî¥ A√ß√£o imediata requerida: Incidentes cr√≠ticos detectados" | tee -a "${REPORT_FILE}"
        echo "   - Revisar logs detalhadamente" | tee -a "${REPORT_FILE}"
        echo "   - Considerar implementa√ß√£o de bloqueios imediatos" | tee -a "${REPORT_FILE}"
        echo "   - Notificar equipe de seguran√ßa" | tee -a "${REPORT_FILE}"
    elif [[ ${THREAT_LEVELS[HIGH]} -gt 0 ]]; then
        echo "üü† Aten√ß√£o necess√°ria: M√∫ltiplas amea√ßas de alto n√≠vel detectadas" | tee -a "${REPORT_FILE}"
        echo "   - Investigar IPs maliciosos" | tee -a "${REPORT_FILE}"
        echo "   - Refor√ßar regras de WAF/Firewall" | tee -a "${REPORT_FILE}"
    elif [[ ${THREAT_LEVELS[MEDIUM]} -gt 0 ]]; then
        echo "üü° Monitorar: Atividades suspeitas detectadas" | tee -a "${REPORT_FILE}"
        echo "   - Acompanhar padr√µes de tr√°fego" | tee -a "${REPORT_FILE}"
        echo "   - Implementar monitoramento adicional" | tee -a "${REPORT_FILE}"
    else
        echo "üü¢ Situa√ß√£o normal: Nenhuma amea√ßa significativa detectada" | tee -a "${REPORT_FILE}"
        echo "   - Manter monitoramento de rotina" | tee -a "${REPORT_FILE}"
    fi
    
    echo "" | tee -a "${REPORT_FILE}"
    echo "EVID√äNCIAS E ARTEFATOS" | tee -a "${REPORT_FILE}"
    echo "------------------------------------------" | tee -a "${REPORT_FILE}"
    echo "Relat√≥rio completo: $REPORT_FILE" | tee -a "${REPORT_FILE}"
    echo "Evid√™ncias detalhadas: $EVIDENCE_DIR" | tee -a "${REPORT_FILE}"
    echo "Intelig√™ncia de amea√ßas: $THREAT_INTEL_DIR" | tee -a "${REPORT_FILE}"
    echo "Estat√≠sticas: $STATS_DIR" | tee -a "${REPORT_FILE}"
}

cleanup_and_exit() {
    local exit_code=$1
    
    # Compactar resultados para arquivamento
    log_message "Compactando resultados forenses..."
    tar -czf "${OUTPUT_DIR}.tar.gz" -C "${OUTPUT_DIR}" . 2>/dev/null
    
    if [[ $? -eq 0 ]]; then
        log_success "An√°lise compactada: ${OUTPUT_DIR}.tar.gz"
    fi
    
    exit $exit_code
}

main() {
    echo -e "${BLUE}${BOLD}"
    echo "=================================================================="
    echo "ANALISADOR FORENSE - INICIANDO AN√ÅLISE"
    echo "=================================================================="
    echo -e "${NC}"
    
    # Validar ambiente
    validate_environment
    
    # Configurar ambiente de an√°lise
    setup_analysis_environment
    
    # Coleta de informa√ß√µes forenses b√°sicas
    collect_basic_forensics
    
    # An√°lises de padr√µes
    analyze_temporal_patterns
    analyze_ip_addresses
    analyze_http_methods
    analyze_status_codes
    analyze_user_agents
    
    # Detec√ß√£o de amea√ßas
    log_section "DETEC√á√ÉO DE AMEA√áAS E ANOMALIAS"
    detect_sql_injection
    detect_xss_attempts
    detect_lfi_attempts
    detect_rce_attempts
    detect_path_traversal
    analyze_sensitive_paths
    
    # Intelig√™ncia de amea√ßas
    generate_threat_intelligence
    
    # Relat√≥rio executivo
    generate_executive_summary
    
    echo -e "\n${GREEN}${BOLD}"
    echo "=================================================================="
    echo "AN√ÅLISE FORENSE CONCLU√çDA COM SUCESSO"
    echo "=================================================================="
    echo -e "${NC}"
    
    log_success "Processo de an√°lise finalizado"
    log_success "Resultados dispon√≠veis em: $OUTPUT_DIR"
    
    cleanup_and_exit 0
}

# Handler para interrup√ß√µes
trap 'echo -e "${RED}${BOLD}\nInterrompido pelo usu√°rio. Finalizando...${NC}"; cleanup_and_exit 1' INT TERM

# Executar an√°lise
main "$@"